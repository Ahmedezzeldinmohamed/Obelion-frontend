name: Deploy Frontend (NodeJS)

on:
  push:
    branches:
      - master # will start when push on the master branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy Frontend via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        
        script: |
          # 1. will install Docker/Git if not found
          if ! [ -x "$(command -v docker)" ]; then
            sudo apt update && sudo apt install -y git docker.io docker-compose
            sudo usermod -aG docker $USER
          fi
          
          # 2. Gather the new Code from GitHub
          sudo rm -rf obelion-frontend
          sudo git clone https://github.com/${{ github.repository }} obelion-frontend
          cd obelion-frontend
          
          # 3. Build Docker Compose (will build Frontend and run on the Port 80)
          # 3. Build Docker Compose
          echo "--- Forcing Docker Cleanup (Stop & Remove All) ---"
          sudo docker stop $(sudo docker ps -aq) || true
          sudo docker rm $(sudo docker ps -aq) || true
          
          sudo docker-compose up -d --build
          
          echo "--- Final Container Status Check ---"
          sudo docker ps -a
          
          echo "Frontend Deployment finished successfully."
